<!DOCTYPE html>
<html>
<head>
    <title>Address Autocomplete</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .autocomplete {
            position: relative;
        }

        .autocomplete input {
            width: 300px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .autocomplete .autocomplete-items {
            display: none; /* Hide the autocomplete items by default */
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 99;
            background-color: #fff;
        }

        .autocomplete .autocomplete-item {
            padding: 10px;
            cursor: pointer;
        }

        .autocomplete .autocomplete-item:hover {
            background-color: #f1f1f1;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 10px auto;
            display: none;
        }

        /* Add animation for the loader */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <h1>Conferences Address Calculator</h1>
    <div id="errorContainer" style="color: red;"></div>
    <div class="autocomplete">
        <input type="text" id="addressInput" placeholder="Enter an address">
        <input type="text" id="customAddressInput" placeholder="Enter a custom address">
        <div class="autocomplete-items" id="autocompleteItems"></div>
    </div>
    <div id="closestConference"></div>
    <!-- Add the loader element -->
    <div class="loader" id="loader"></div>
    

    <script>
        const addressInput = document.getElementById('addressInput');
        const autocompleteItems = document.getElementById('autocompleteItems');
        let conferences = []; // To store the loaded conference data

        // Function to show the loader
        function showLoader() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
        }

        // Function to hide the loader
        function hideLoader() {
            const loader = document.getElementById('loader');
            loader.style.display = 'none';
        }


        // Function to fetch the conference data from the JSON file
        async function fetchConferenceData() {
            try {
                const response = await fetch('conference.json');
                const data = await response.json();
                conferences = data.conferences;

                // Fetch geocode (latitude and longitude) for each conference address
                for (const conference of conferences) {
                    try {
                        const geocode = await getGeocode(conference.address);
                        conference.lat = geocode.lat;
                        conference.lon = geocode.lon;
                    } catch (error) {
                        console.error(`Error fetching geocode for conference '${conference.name}':`, error);
                    }
                }
            } catch (error) {
                console.error('Error fetching conference data:', error);
            }
        }


         // Function to handle address search
        function searchAddress() {
            // Get the user input from the input box
            const userInput = addressInput.value;
            autocompleteItems.innerHTML = '';
            autocompleteItems.style.display = userInput.length > 0 ? 'block' : 'none';

            // Show all conference names in autocomplete
            conferences.forEach(conference => {
                const item = document.createElement('div');
                item.classList.add('autocomplete-item');
                item.innerText = conference.name;
                item.addEventListener('click', () => {
                    addressInput.value = conference.name;
                    autocompleteItems.innerHTML = '';
                    onAddressSelected(conference); // Pass the conference object here
                });
                autocompleteItems.appendChild(item);
            });
        }


        // Event listener to trigger search on input change
        addressInput.addEventListener('input', searchAddress);


        // Function to calculate distance using Haversine formula
        function haversineDistance(lat1, lon1, lat2, lon2) {

            console.log(lat1, lon1, lat2, lon2)
            const R = 6371; // Radius of the earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance;
        }

        // Function to get the latitude and longitude of an address using Nominatim API
        async function getGeocode(address) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                } else {
                    throw new Error('Address not found.');
                }
            } catch (error) {
                console.error(error);
                throw error;
            }
        }

       // Function to get the current location using the Geolocation API
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            resolve({ lat: latitude, lon: longitude });
                        },
                        error => reject(error)
                    );
                } else {
                    reject(new Error('Geolocation is not supported by this browser.'));
                }
            });
        }

        // Function to get the location name using the Nominatim API
        async function getLocationName(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.display_name) {
                    return data.display_name;
                } else {
                    throw new Error('Location name not found.');
                }
            } catch (error) {
                console.error(error);
                throw error;
            }
        }


        // Event listener to handle address selection
        async function onAddressSelected(conference) {
            try {
                showLoader();

                const selectedAddress = addressInput.value;

                // Get the latitude and longitude of the selected address using Nominatim API
                const selectedGeocode = await getGeocode(selectedAddress);



                // Get the latitude and longitude of the current location using Geolocation API
                const customAddress = document.getElementById('customAddressInput').value;
                let currentGeocode;

                if (customAddress.length > 0) {
                    currentGeocode = await getGeocode(customAddress);
                } else {
                    currentGeocode = await getCurrentLocation();
                    // console.log(`i am current: ${currentGeocode}`)

                }

                // Get the name of the current location using Nominatim API
                const currentLocationName = await getLocationName(currentGeocode.lat, currentGeocode.lon);

                // Calculate the distance between the selected address and the conference's address
                const distance = haversineDistance(
                    selectedGeocode.lat, selectedGeocode.lon,
                    // conference.lat, conference.lon,
                    currentGeocode.lat, currentGeocode.lon,
                    
                );

                // Calculate the distance between the current location and the conference's address
                const distanceToCurrent = haversineDistance(
                    currentGeocode.lat, currentGeocode.lon,
                    // conference.lat, conference.lon,
                    selectedGeocode.lat, selectedGeocode.lon,
                );

                // Display the closest conference below the input bar
                const closestConference = document.getElementById('closestConference');
                closestConference.innerHTML = `<strong>Closest Conference:</strong> ${conference.name} (${distance.toFixed(2)} km)`;
                closestConference.innerHTML += `<br><strong>Distance from ${currentLocationName} to ${conference.name}: </strong> ${distanceToCurrent.toFixed(2)} km`;

                hideLoader();

            } catch (error) {
                hideLoader();
                // Handle any errors that may occur during distance calculation
                console.error(error);

            }
        }

        // Load conference data and initialize autocomplete
        fetchConferenceData().then(() => {
            // Perform initial search to show all conference names
            searchAddress();
        });
    </script>
</body>
</html>
